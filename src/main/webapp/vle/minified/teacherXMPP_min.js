var Base64=function(){return{encode:function(c){var b="",e,g,n,d,a,f,l=0;do e=c.charCodeAt(l++),g=c.charCodeAt(l++),n=c.charCodeAt(l++),d=e>>2,e=(e&3)<<4|g>>4,a=(g&15)<<2|n>>6,f=n&63,isNaN(g)?a=f=64:isNaN(n)&&(f=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(e)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(a)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f);
while(l<c.length);return b},decode:function(c){var b="",e,g,n,d,a,f=0,c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),e=e<<2|g>>4,g=(g&15)<<
4|d>>2,n=(d&3)<<6|a,b+=String.fromCharCode(e),d!=64&&(b+=String.fromCharCode(g)),a!=64&&(b+=String.fromCharCode(n));while(f<c.length);return b}}}();typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/base64.js");jQuery.cookie=function(c,b,e){if(arguments.length>1&&String(b)!=="[object Object]"){e=jQuery.extend({},e);if(b===null||b===void 0)e.expires=-1;if(typeof e.expires==="number"){var g=e.expires,n=e.expires=new Date;n.setDate(n.getDate()+g)}b=String(b);return document.cookie=[encodeURIComponent(c),"=",e.raw?b:encodeURIComponent(b),e.expires?"; expires="+e.expires.toUTCString():"",e.path?"; path="+e.path:"",e.domain?"; domain="+e.domain:"",e.secure?"; secure":""].join("")}e=b||{};n=e.raw?function(d){return d}:
decodeURIComponent;return(g=RegExp("(?:^|; )"+encodeURIComponent(c)+"=([^;]*)").exec(document.cookie))?n(g[1]):null};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/jquery.cookie.js");jQuery.url=function(){var c={},b={},e={url:window.location,strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},
g=function(){str=decodeURI(e.url);for(var d=e.parser[e.strictMode?"strict":"loose"].exec(str),a={},f=14;f--;)a[e.key[f]]=d[f]||"";a[e.q.name]={};a[e.key[12]].replace(e.q.parser,function(d,f,c){f&&(a[e.q.name][f]=c)});return a},n=function(){b=g();var d=b.path;c=[];c=b.path.length==1?{}:(d.charAt(d.length-1)=="/"?d.substring(1,d.length-1):path=d.substring(1)).split("/")};return{setMode:function(d){e.strictMode=d=="strict"?!0:!1;return this},setUrl:function(d){e.url=d===void 0?window.location:d;n();
return this},segment:function(d){jQuery.isEmptyObject(b)&&n();return d===void 0?c.length:c[d]===""||c[d]===void 0?null:c[d]},attr:function(d){jQuery.isEmptyObject(b)&&n();return d=="base"?b.port!==null&&b.port!==""?b.protocol+"://"+b.host+":"+b.port+"/":b.protocol+"://"+b.host+"/":b[d]===""?null:b[d]},param:function(d){jQuery.isEmptyObject(b)&&n();return b.queryKey[d]===null?null:b.queryKey[d]}}}();typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/jquery.url.js");(function(c){var c=c||{},b={},e,g;e=function(c,d,a){var f=c.halt=!1;c.error=function(a){throw a;};c.next=function(a){a&&(f=!1);if(!c.halt&&d&&d.length){var a=d.shift(),l=a.shift();f=!0;try{b[l].apply(c,[a,a.length,l])}catch(p){c.error(p)}}return c};for(var l in b)typeof c[l]!=="function"&&function(a){c[a]=function(){var l=Array.prototype.slice.call(arguments);if(a==="onError"){if(d)return b.onError.apply(c,[l,l.length]),c;var p={};b.onError.apply(p,[l,l.length]);return e(p,null,"onError")}l.unshift(a);
if(!d)return e({},[l],a);c.then=c[a];d.push(l);return f?c:c.next()}}(l);a&&(c.then=c[a]);c.call=function(a,f){f.unshift(a);d.unshift(f);c.next(!0)};return c.next()};g=c.addMethod=function(g){for(var d=Array.prototype.slice.call(arguments),a=d.pop(),f=0,l=d.length;f<l;f++)typeof d[f]==="string"&&(b[d[f]]=a);--l||(b["then"+g.substr(0,1).toUpperCase()+g.substr(1)]=a);e(c)};g("chain",function(c){var d=this,a=function(){if(!d.halt){if(!c.length)return d.next(!0);try{null!=c.shift().call(d,a,d.error)&&
a()}catch(f){d.error(f)}}};a()});g("run",function(c,d){for(var a=this,f=function(){a.halt||--d||a.next(!0)},l=function(d){a.error(d)},b=0,g=d;!a.halt&&b<g;b++)null!=c[b].call(a,f,l)&&f()});g("defer",function(c){var d=this;setTimeout(function(){d.next(!0)},c.shift())});g("onError",function(c,d){var a=this;this.error=function(f){a.halt=!0;for(var l=0;l<d;l++)c[l].call(a,f)}})})(this);
addMethod("load",function(c,b){for(var e=[],g=0;g<b;g++)(function(b){e.push(function(d,a){loadScript(c[b],d,a)})})(g);this.call("run",e)});var head=document.getElementsByTagName("head")[0]||document.documentElement;function loadScript(c,b,e){var g=document.createElement("script");g.type="text/javascript";g.src=c;g.onload=b;g.onerror=e;g.onreadystatechange=function(){var c=this.readyState;if(c==="loaded"||c==="complete")g.onreadystatechange=null,b()};head.insertBefore(g,head.firstChild)}
typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/load.js");var MD5=function(){var c=function(a,d){var f=(a&65535)+(d&65535);return(a>>16)+(d>>16)+(f>>16)<<16|f&65535},b=function(a){for(var d=[],f=0;f<a.length*8;f+=8)d[f>>5]|=(a.charCodeAt(f/8)&255)<<f%32;return d},e=function(a){for(var d="",f=0;f<a.length*32;f+=8)d+=String.fromCharCode(a[f>>5]>>>f%32&255);return d},g=function(a){for(var f="",d=0;d<a.length*4;d++)f+="0123456789abcdef".charAt(a[d>>2]>>d%4*8+4&15)+"0123456789abcdef".charAt(a[d>>2]>>d%4*8&15);return f},n=function(a){for(var d="",f,l,c=0;c<a.length*
4;c+=3){f=(a[c>>2]>>8*(c%4)&255)<<16|(a[c+1>>2]>>8*((c+1)%4)&255)<<8|a[c+2>>2]>>8*((c+2)%4)&255;for(l=0;l<4;l++)d+=c*8+l*6>a.length*32?"":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>6*(3-l)&63)}return d},d=function(a,d,f,l,b,g){a=c(c(d,a),c(l,g));return c(a<<b|a>>>32-b,f)},a=function(a,f,l,c,b,g,e){return d(f&l|~f&c,a,f,b,g,e)},f=function(a,f,l,c,b,g,e){return d(f&c|l&~c,a,f,b,g,e)},l=function(a,f,l,c,b,g,e){return d(l^(f|~c),a,f,b,g,e)},h=function(b,g){b[g>>5]|=128<<
g%32;b[(g+64>>>9<<4)+14]=g;for(var e=1732584193,h=-271733879,j=-1732584194,k=271733878,q,n,r,s,m=0;m<b.length;m+=16)q=e,n=h,r=j,s=k,e=a(e,h,j,k,b[m+0],7,-680876936),k=a(k,e,h,j,b[m+1],12,-389564586),j=a(j,k,e,h,b[m+2],17,606105819),h=a(h,j,k,e,b[m+3],22,-1044525330),e=a(e,h,j,k,b[m+4],7,-176418897),k=a(k,e,h,j,b[m+5],12,1200080426),j=a(j,k,e,h,b[m+6],17,-1473231341),h=a(h,j,k,e,b[m+7],22,-45705983),e=a(e,h,j,k,b[m+8],7,1770035416),k=a(k,e,h,j,b[m+9],12,-1958414417),j=a(j,k,e,h,b[m+10],17,-42063),
h=a(h,j,k,e,b[m+11],22,-1990404162),e=a(e,h,j,k,b[m+12],7,1804603682),k=a(k,e,h,j,b[m+13],12,-40341101),j=a(j,k,e,h,b[m+14],17,-1502002290),h=a(h,j,k,e,b[m+15],22,1236535329),e=f(e,h,j,k,b[m+1],5,-165796510),k=f(k,e,h,j,b[m+6],9,-1069501632),j=f(j,k,e,h,b[m+11],14,643717713),h=f(h,j,k,e,b[m+0],20,-373897302),e=f(e,h,j,k,b[m+5],5,-701558691),k=f(k,e,h,j,b[m+10],9,38016083),j=f(j,k,e,h,b[m+15],14,-660478335),h=f(h,j,k,e,b[m+4],20,-405537848),e=f(e,h,j,k,b[m+9],5,568446438),k=f(k,e,h,j,b[m+14],9,-1019803690),
j=f(j,k,e,h,b[m+3],14,-187363961),h=f(h,j,k,e,b[m+8],20,1163531501),e=f(e,h,j,k,b[m+13],5,-1444681467),k=f(k,e,h,j,b[m+2],9,-51403784),j=f(j,k,e,h,b[m+7],14,1735328473),h=f(h,j,k,e,b[m+12],20,-1926607734),e=d(h^j^k,e,h,b[m+5],4,-378558),k=d(e^h^j,k,e,b[m+8],11,-2022574463),j=d(k^e^h,j,k,b[m+11],16,1839030562),h=d(j^k^e,h,j,b[m+14],23,-35309556),e=d(h^j^k,e,h,b[m+1],4,-1530992060),k=d(e^h^j,k,e,b[m+4],11,1272893353),j=d(k^e^h,j,k,b[m+7],16,-155497632),h=d(j^k^e,h,j,b[m+10],23,-1094730640),e=d(h^j^
k,e,h,b[m+13],4,681279174),k=d(e^h^j,k,e,b[m+0],11,-358537222),j=d(k^e^h,j,k,b[m+3],16,-722521979),h=d(j^k^e,h,j,b[m+6],23,76029189),e=d(h^j^k,e,h,b[m+9],4,-640364487),k=d(e^h^j,k,e,b[m+12],11,-421815835),j=d(k^e^h,j,k,b[m+15],16,530742520),h=d(j^k^e,h,j,b[m+2],23,-995338651),e=l(e,h,j,k,b[m+0],6,-198630844),k=l(k,e,h,j,b[m+7],10,1126891415),j=l(j,k,e,h,b[m+14],15,-1416354905),h=l(h,j,k,e,b[m+5],21,-57434055),e=l(e,h,j,k,b[m+12],6,1700485571),k=l(k,e,h,j,b[m+3],10,-1894986606),j=l(j,k,e,h,b[m+10],
15,-1051523),h=l(h,j,k,e,b[m+1],21,-2054922799),e=l(e,h,j,k,b[m+8],6,1873313359),k=l(k,e,h,j,b[m+15],10,-30611744),j=l(j,k,e,h,b[m+6],15,-1560198380),h=l(h,j,k,e,b[m+13],21,1309151649),e=l(e,h,j,k,b[m+4],6,-145523070),k=l(k,e,h,j,b[m+11],10,-1120210379),j=l(j,k,e,h,b[m+2],15,718787259),h=l(h,j,k,e,b[m+9],21,-343485551),e=c(e,q),h=c(h,n),j=c(j,r),k=c(k,s);return[e,h,j,k]},q=function(a,f){var d=b(a);d.length>16&&(d=h(d,a.length*8));for(var l=Array(16),c=Array(16),e=0;e<16;e++)l[e]=d[e]^909522486,c[e]=
d[e]^1549556828;d=h(l.concat(b(f)),512+f.length*8);return h(c.concat(d),640)};return{hexdigest:function(a){return g(h(b(a),a.length*8))},b64digest:function(a){return n(h(b(a),a.length*8))},hash:function(a){return e(h(b(a),a.length*8))},hmac_hexdigest:function(a,f){return g(q(a,f))},hmac_b64digest:function(a,f){return n(q(a,f))},hmac_hash:function(a,f){return e(q(a,f))},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72"}}}();
typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/md5.js");if(!Function.prototype.bind)Function.prototype.bind=function(c){var b=this,e=Array.prototype.slice,g=Array.prototype.concat,n=e.call(arguments,1);return function(){return b.apply(c?c:this,g.call(n,e.call(arguments,0)))}};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(c,b){var e=this.length,g=Number(b)||0,g=g<0?Math.ceil(g):Math.floor(g);for(g<0&&(g+=e);g<e;g++)if(g in this&&this[g]===c)return g;return-1};
(function(c){function b(a,f){return new d.Builder(a,f)}function e(a){return new d.Builder("message",a)}function g(a){return new d.Builder("iq",a)}function n(a){return new d.Builder("presence",a)}var d;d={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",
SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(a,f){d.NS[a]=f},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,
forEachChild:function(a,f,b){var c,e;for(c=0;c<a.childNodes.length;c++)e=a.childNodes[c],e.nodeType==d.ElementType.NORMAL&&(!f||this.isTagEqual(e,f))&&b(e)},isTagEqual:function(a,f){return a.tagName.toLowerCase()==f.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var a;window.ActiveXObject?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){if(!d._xmlGenerator)d._xmlGenerator=
d._makeGenerator();return d._xmlGenerator},_getIEXmlDom:function(){for(var a=null,f=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],d=0;d<f.length;d++)if(a===null)try{a=new ActiveXObject(f[d])}catch(b){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var f=d.xmlGenerator().createElement(a),b,c,e;for(b=1;b<arguments.length;b++)if(arguments[b])if(typeof arguments[b]==
"string"||typeof arguments[b]=="number")f.appendChild(d.xmlTextNode(arguments[b]));else if(typeof arguments[b]=="object"&&typeof arguments[b].sort=="function")for(c=0;c<arguments[b].length;c++)typeof arguments[b][c]=="object"&&typeof arguments[b][c].sort=="function"&&f.setAttribute(arguments[b][c][0],arguments[b][c][1]);else if(typeof arguments[b]=="object")for(e in arguments[b])arguments[b].hasOwnProperty(e)&&f.setAttribute(e,arguments[b][e]);return f},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");
a=a.replace(/</g,"&lt;");return a=a.replace(/>/g,"&gt;")},xmlTextNode:function(a){a=d.xmlescape(a);return d.xmlGenerator().createTextNode(a)},getText:function(a){if(!a)return null;var f="";a.childNodes.length===0&&a.nodeType==d.ElementType.TEXT&&(f+=a.nodeValue);for(var b=0;b<a.childNodes.length;b++)a.childNodes[b].nodeType==d.ElementType.TEXT&&(f+=a.childNodes[b].nodeValue);return f},copyElement:function(a){var f,b;if(a.nodeType==d.ElementType.NORMAL){b=d.xmlElement(a.tagName);for(f=0;f<a.attributes.length;f++)b.setAttribute(a.attributes[f].nodeName.toLowerCase(),
a.attributes[f].value);for(f=0;f<a.childNodes.length;f++)b.appendChild(d.copyElement(a.childNodes[f]))}else a.nodeType==d.ElementType.TEXT&&(b=d.xmlTextNode(a.nodeValue));return b},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g,
" ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return a.indexOf("@")<0?null:a.split("@")[0]},getDomainFromJid:function(a){a=d.getBareJidFromJid(a);return a.indexOf("@")<0?a:(a=a.split("@"),a.splice(0,1),a.join("@"))},getResourceFromJid:function(a){a=a.split("/");if(a.length<2)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?
a.split("/")[0]:null},log:function(){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var f;if(!a)return null;typeof a.tree==="function"&&(a=a.tree());var b=a.nodeName,c,e;a.getAttribute("_realname")&&(b=a.getAttribute("_realname"));f="<"+b;for(c=0;c<a.attributes.length;c++)a.attributes[c].nodeName!=
"_realname"&&(f+=" "+a.attributes[c].nodeName.toLowerCase()+"='"+a.attributes[c].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(a.childNodes.length>0){f+=">";for(c=0;c<a.childNodes.length;c++)e=a.childNodes[c],e.nodeType==d.ElementType.NORMAL?f+=d.serialize(e):e.nodeType==d.ElementType.TEXT&&(f+=e.nodeValue);f+="</"+b+">"}else f+="/>";return f},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,f){d._connectionPlugins[a]=f}};d.Builder=function(a,f){if(a==
"presence"||a=="message"||a=="iq")f&&!f.xmlns?f.xmlns=d.NS.CLIENT:f||(f={xmlns:d.NS.CLIENT});this.node=this.nodeTree=d.xmlElement(a,f)};d.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return d.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var f in a)a.hasOwnProperty(f)&&this.node.setAttribute(f,a[f]);return this},c:function(a,f){var b=d.xmlElement(a,f);this.node.appendChild(b);this.node=b;return this},cnode:function(a){var f=
d.xmlGenerator(),a=f.importNode?f.importNode(a,!0):d.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){this.node.appendChild(d.xmlTextNode(a));return this}};d.Handler=function(a,f,b,c,e,g,n){this.handler=a;this.ns=f;this.name=b;this.type=c;this.id=e;this.options=n||{matchbare:!1};if(!this.options.matchBare)this.options.matchBare=!1;this.from=this.options.matchBare?g?d.getBareJidFromJid(g):null:g;this.user=!0};d.Handler.prototype={isMatch:function(a){var f,b=null,b=this.options.matchBare?
d.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");f=!1;if(this.ns){var c=this;d.forEachChild(a,null,function(a){a.getAttribute("xmlns")==c.ns&&(f=!0)});f=f||a.getAttribute("xmlns")==this.ns}else f=!0;return f&&(!this.name||d.isTagEqual(a,this.name))&&(!this.type||a.getAttribute("type")==this.type)&&(!this.id||a.getAttribute("id")==this.id)&&(!this.from||b==this.from)?!0:!1},run:function(a){var f=null;try{f=this.handler(a)}catch(b){throw b.sourceURL?d.fatal("error: "+this.handler+
" "+b.sourceURL+":"+b.line+" - "+b.name+": "+b.message):b.fileName?(typeof console!="undefined"&&(console.trace(),console.error(this.handler," - error - ",b,b.message)),d.fatal("error: "+this.handler+" "+b.fileName+":"+b.lineNumber+" - "+b.name+": "+b.message)):d.fatal("error: "+this.handler),b;}return f},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};d.TimedHandler=function(a,f){this.period=a;this.handler=f;this.lastCalled=(new Date).getTime();this.user=
!0};d.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};d.Request=function(a,f,b,c){this.id=++d._requestId;this.xmlData=a;this.data=d.serialize(a);this.func=this.origFunc=f;this.rid=b;this.date=NaN;this.sends=c||0;this.abort=!1;this.dead=null;this.age=function(){return!this.date?0:(new Date-this.date)/1E3};this.timeDead=
function(){return!this.dead?0:(new Date-this.dead)/1E3};this.xhr=this._newXHR()};d.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,a.tagName=="parsererror")throw d.error("invalid response received"),d.error("responseText: "+this.xhr.responseText),d.error("responseXML: "+d.serialize(this.xhr.responseXML)),"parsererror";}else this.xhr.responseText&&(d.error("invalid response received"),d.error("responseText: "+
this.xhr.responseText),d.error("responseXML: "+d.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};d.Connection=function(a){this.service=a;this.jid="";this.rid=Math.floor(Math.random()*4294967295);this.features=this.streamId=this.sid=null;this.do_bind=this.do_session=
!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._disconnectTimeout=this._idleTimeout=null;this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this.paused=!1;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*1E4);this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this._idleTimeout=setTimeout(this._onIdle.bind(this),
100);for(var f in d._connectionPlugins)if(d._connectionPlugins.hasOwnProperty(f))a=function(){},a.prototype=d._connectionPlugins[f],this[f]=new a,this[f].init(this)};d.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.streamId=this.sid=null;this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.connected=this.disconnecting=this.authenticated=!1;this.errors=
0;this._requests=[];this._uniqueId=Math.round(Math.random()*1E4)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return typeof a=="string"||typeof a=="number"?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,f,b,c,e){this.jid=a;this.pass=f;this.connect_callback=b;this.authenticated=this.connected=this.disconnecting=!1;this.errors=0;this.wait=c||this.wait;this.hold=e||this.hold;this.domain=d.getDomainFromJid(this.jid);a=this._buildBody().attrs({to:this.domain,
"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":d.NS.BOSH});this._changeConnectStatus(d.Status.CONNECTING,null);this._requests.push(new d.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(a,f,b,c,e,g,n){this.jid=a;this.sid=f;this.rid=b;this.connect_callback=c;this.domain=d.getDomainFromJid(this.jid);this.connected=
this.authenticated=!0;this.wait=e||this.wait;this.hold=g||this.hold;this.window=n||this.window;this._changeConnectStatus(d.Status.ATTACHED,null)},xmlInput:function(){},xmlOutput:function(){},rawInput:function(){},rawOutput:function(){},send:function(a){if(a!==null){if(typeof a.sort==="function")for(var f=0;f<a.length;f++)this._queueData(a[f]);else typeof a.tree==="function"?this._queueData(a.tree()):this._queueData(a);this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=
setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,f,d,b){var c=null,e=this;typeof a.tree==="function"&&(a=a.tree());var g=a.getAttribute("id");g||(g=this.getUniqueId("sendIQ"),a.setAttribute("id",g));var n=this.addHandler(function(a){c&&e.deleteTimedHandler(c);var b=a.getAttribute("type");if(b=="result")f&&f(a);else if(b=="error")d&&d(a);else throw{name:"StropheError",message:"Got bad IQ type of "+b};},null,"iq",null,g);b&&
(c=this.addTimedHandler(b,function(){e.deleteHandler(n);d&&d(null);return!1}));this.send(a);return g},_queueData:function(a){if(a===null||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,f){var b=new d.TimedHandler(a,f);this.addTimeds.push(b);
return b},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,f,b,c,e,g,n){a=new d.Handler(a,f,b,c,e,g,n);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(d.Status.DISCONNECTING,a);d.info("Disconnect was called because: "+a);if(this.connected)this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._sendTerminate()},_changeConnectStatus:function(a,
f){for(var b in d._connectionPlugins)if(d._connectionPlugins.hasOwnProperty(b)){var c=this[b];if(c.statusChanged)try{c.statusChanged(a,f)}catch(e){d.error(""+b+" plugin caused an exception changing status: "+e)}}if(this.connect_callback)try{this.connect_callback(a,f)}catch(g){d.error("User connection callback caused an exception: "+g)}},_buildBody:function(){var a=b("body",{rid:this.rid++,xmlns:d.NS.HTTPBIND});this.sid!==null&&a.attrs({sid:this.sid});return a},_removeRequest:function(a){d.debug("removing request");
var f;for(f=this._requests.length-1;f>=0;f--)a==this._requests[f]&&this._requests.splice(f,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var d=this._requests[a];if(d.dead===null)d.dead=new Date;this._processRequest(a)},_processRequest:function(a){var f=this._requests[a],b=-1;try{if(f.xhr.readyState==4)b=f.xhr.status}catch(c){d.error("caught an error in _requests["+a+"], reqStatus: "+b)}typeof b=="undefined"&&(b=-1);if(f.sends>5)this._onDisconnectTimeout();
else{var e=f.age(),e=!isNaN(e)&&e>Math.floor(d.TIMEOUT*this.wait),g=f.dead!==null&&f.timeDead()>Math.floor(d.SECONDARY_TIMEOUT*this.wait),b=f.xhr.readyState==4&&(b<1||b>=500);if(e||g||b)g&&d.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),f.abort=!0,f.xhr.abort(),f.xhr.onreadystatechange=function(){},this._requests[a]=new d.Request(f.xmlData,f.origFunc,f.rid,f.sends),f=this._requests[a];if(f.xhr.readyState===0){d.debug("request id "+f.id+"."+f.sends+" posting");try{f.xhr.open("POST",
this.service,!0)}catch(n){d.error("XHR open failed.");this.connected||this._changeConnectStatus(d.Status.CONNFAIL,"bad-service");this.disconnect();return}a=function(){f.date=new Date;f.xhr.send(f.data)};f.sends>1?setTimeout(a,Math.min(Math.floor(d.TIMEOUT*this.wait),Math.pow(f.sends,3))*1E3):a();f.sends++;this.xmlOutput(f.xmlData);this.rawOutput(f.data)}else d.debug("_processRequest: "+(a===0?"first":"second")+" request has readyState of "+f.xhr.readyState)}},_throttledRequestHandler:function(){this._requests?
d.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):d.debug("_throttledRequestHandler called with undefined requests");this._requests&&this._requests.length!==0&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))},_onRequestStateChange:function(a,b){d.debug("request id "+b.id+"."+b.sends+" state changed to "+b.xhr.readyState);if(b.abort)b.abort=!1;else{var c;
if(b.xhr.readyState==4){c=0;try{c=b.xhr.status}catch(e){}typeof c=="undefined"&&(c=0);if(this.disconnecting&&c>=400)this._hitError(c);else{var g=this._requests[0]==b,n=this._requests[1]==b;if(c>0&&c<500||b.sends>5)this._removeRequest(b),d.debug("request id "+b.id+" should now be removed");if(c==200)(n||g&&this._requests.length>0&&this._requests[0].age()>Math.floor(d.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),d.debug("request id "+b.id+"."+b.sends+" got 200"),a(b),this.errors=0;else if(d.error("request id "+
b.id+"."+b.sends+" error "+c+" happened"),c===0||c>=400&&c<600||c>=12E3)this._hitError(c),c>=400&&c<500&&(this._changeConnectStatus(d.Status.DISCONNECTING,null),this._doDisconnect());c>0&&c<500||b.sends>5||this._throttledRequestHandler()}}}},_hitError:function(a){this.errors++;d.warn("request errored, status: "+a+", number of errors: "+this.errors);this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){d.info("_doDisconnect was called");this.disconnecting=this.authenticated=!1;this.streamId=
this.sid=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected)this._changeConnectStatus(d.Status.DISCONNECTED,null),this.connected=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(a){try{var b=a.getResponse()}catch(c){if(c!="parsererror")throw c;this.disconnect("strophe-parsererror")}if(b!==null){this.xmlInput(b);for(this.rawInput(d.serialize(b));this.removeHandlers.length>0;)a=this.removeHandlers.pop(),
a=this.handlers.indexOf(a),a>=0&&this.handlers.splice(a,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._requests.length===0)this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect();else if(a=b.getAttribute("type"),a!==null&&a=="terminate")this.disconnecting||(a=b.getAttribute("condition"),b=b.getElementsByTagName("conflict"),a!==null?(a=="remote-stream-error"&&b.length>0&&(a="conflict"),this._changeConnectStatus(d.Status.CONNFAIL,
a)):this._changeConnectStatus(d.Status.CONNFAIL,"unknown"),this.disconnect());else{var e=this;d.forEachChild(b,null,function(a){var b,d;d=e.handlers;e.handlers=[];for(b=0;b<d.length;b++){var f=d[b];f.isMatch(a)&&(e.authenticated||!f.user)?f.run(a)&&e.handlers.push(f):e.handlers.push(f)}})}}},_sendTerminate:function(){d.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});this.authenticated&&a.c("presence",{xmlns:d.NS.CLIENT,type:"unavailable"});this.disconnecting=!0;
this._requests.push(new d.Request(a.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},_connect_cb:function(a){d.info("_connect_cb was called");this.connected=!0;if(a=a.getResponse()){this.xmlInput(a);this.rawInput(d.serialize(a));var f=a.getAttribute("type");if(f!==null&&f=="terminate")f=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),f!==null?(f=="remote-stream-error"&&a.length>0&&(f="conflict"),
this._changeConnectStatus(d.Status.CONNFAIL,f)):this._changeConnectStatus(d.Status.CONNFAIL,"unknown");else{if(!this.sid)this.sid=a.getAttribute("sid");if(!this.stream_id)this.stream_id=a.getAttribute("authid");if(f=a.getAttribute("requests"))this.window=parseInt(f,10);if(f=a.getAttribute("hold"))this.hold=parseInt(f,10);if(f=a.getAttribute("wait"))this.wait=parseInt(f,10);var c=f=!1,e=!1,a=a.getElementsByTagName("mechanism"),n,p;if(a.length>0){for(n=0;n<a.length;n++)p=d.getText(a[n]),p=="DIGEST-MD5"?
c=!0:p=="PLAIN"?f=!0:p=="ANONYMOUS"&&(e=!0);d.getNodeFromJid(this.jid)===null&&e?(this._changeConnectStatus(d.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(b("auth",{xmlns:d.NS.SASL,mechanism:"ANONYMOUS"}).tree())):d.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(d.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),
this.disconnect()):c?(this._changeConnectStatus(d.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(b("auth",{xmlns:d.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):f?(a=d.getBareJidFromJid(this.jid),a+="\000",a+=d.getNodeFromJid(this.jid),a+="\000",a+=this.pass,this._changeConnectStatus(d.Status.AUTHENTICATING,
null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),a=Base64.encode(a),this.send(b("auth",{xmlns:d.NS.SASL,mechanism:"PLAIN"}).t(a).tree())):(this._changeConnectStatus(d.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(g({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:d.NS.AUTH}).c("username",
{}).t(d.getNodeFromJid(this.jid)).tree()))}else a=this._buildBody(),this._requests.push(new d.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid"))),this._throttledRequestHandler()}}},_sasl_challenge1_cb:function(a){var f=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,c=Base64.decode(d.getText(a)),a=MD5.hexdigest(Math.random()*1234567890),e="",g=null,n="",o;for(this.deleteHandler(this._sasl_failure_handler);c.match(f);)switch(o=c.match(f),c=c.replace(o[0],
""),o[2]=o[2].replace(/^"(.+)"$/,"$1"),o[1]){case "realm":e=o[2];break;case "nonce":n=o[2];break;case "host":g=o[2]}f="xmpp/"+this.domain;g!==null&&(f=f+"/"+g);g=MD5.hash(d.getNodeFromJid(this.jid)+":"+e+":"+this.pass)+":"+n+":"+a;c="AUTHENTICATE:"+f;o="";o+="username="+this._quote(d.getNodeFromJid(this.jid))+",";o+="realm="+this._quote(e)+",";o+="nonce="+this._quote(n)+",";o+="cnonce="+this._quote(a)+",";o+='nc="00000001",';o+='qop="auth",';o+="digest-uri="+this._quote(f)+",";o+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(g)+
":"+n+":00000001:"+a+":auth:"+MD5.hexdigest(c)))+",";o+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(b("response",{xmlns:d.NS.SASL}).t(Base64.encode(o)).tree());return!1},_quote:function(a){return'"'+
a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(b("response",{xmlns:d.NS.SASL}).tree());return!1},_auth1_cb:function(){var a=g({type:"set",id:"_auth_2"}).c("query",
{xmlns:d.NS.AUTH}).c("username",{}).t(d.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!d.getResourceFromJid(this.jid))this.jid=d.getBareJidFromJid(this.jid)+"/strophe";a.up().c("resource",{}).t(d.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(){d.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler)this.deleteHandler(this._sasl_challenge_handler),
this._sasl_challenge_handler=null;this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var b,c;for(b=0;b<a.childNodes.length;b++){c=a.childNodes[b];if(c.nodeName=="bind")this.do_bind=!0;if(c.nodeName=="session")this.do_session=!0}this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=d.getResourceFromJid(this.jid))?this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",
{xmlns:d.NS.BIND}).c("resource",{}).t(a).tree()):this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:d.NS.BIND}).tree())):this._changeConnectStatus(d.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if(a.getAttribute("type")=="error")return d.info("SASL binding failed."),this._changeConnectStatus(d.Status.AUTHFAIL,null),!1;a=a.getElementsByTagName("bind");if(a.length>0){if(a=a[0].getElementsByTagName("jid"),a.length>0)this.jid=d.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),
null,null,null,"_session_auth_2"),this.send(g({type:"set",id:"_session_auth_2"}).c("session",{xmlns:d.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null))}else return d.info("SASL binding failed."),this._changeConnectStatus(d.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){a.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null)):a.getAttribute("type")=="error"&&(d.info("Session creation failed."),
this._changeConnectStatus(d.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(){if(this._sasl_success_handler)this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null;if(this._sasl_challenge_handler)this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null;this._changeConnectStatus(d.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){a.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null)):
a.getAttribute("type")=="error"&&(this._changeConnectStatus(d.Status.AUTHFAIL,null),this.disconnect());return!1},_addSysTimedHandler:function(a,b){var c=new d.TimedHandler(a,b);c.user=!1;this.addTimeds.push(c);return c},_addSysHandler:function(a,b,c,e,g){a=new d.Handler(a,b,c,e,g);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){d.info("_onDisconnectTimeout was called");for(var a;this._requests.length>0;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=
function(){};this._doDisconnect();return!1},_onIdle:function(){for(var a,b,c,e;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),a>=0&&this.timedHandlers.splice(a,1);var g=(new Date).getTime();e=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)c=b.lastCalled+b.period,c-g<=0?b.run()&&e.push(b):e.push(b);this.timedHandlers=e;this.authenticated&&
this._requests.length===0&&this._data.length===0&&!this.disconnecting&&(d.info("no requests during idle cycle, sending blank request"),this._data.push(null));if(this._requests.length<2&&this._data.length>0&&!this.paused){b=this._buildBody();for(a=0;a<this._data.length;a++)this._data[a]!==null&&(this._data[a]==="restart"?b.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":d.NS.BOSH}):b.cnode(this._data[a]).up());delete this._data;this._data=[];this._requests.push(new d.Request(b.tree(),
this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),b.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}this._requests.length>0&&(a=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(d.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),a>Math.floor(d.TIMEOUT*this.wait)&&(d.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(d.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()));
clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}};c&&c(d,b,e,g,n)})(function(c,b,e,g,n){window.Strophe=c;window.$build=b;window.$msg=e;window.$iq=g;window.$pres=n});typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/strophe.js");function loadScript(c,b,e){var g=document.createElement("script");g.type="text/javascript";g.src=c;g.onload=b;g.onerror=e;g.onreadystatechange=function(){var c=this.readyState;if(c==="loaded"||c==="complete")g.onreadystatechange=null,b()};head.insertBefore(g,head.firstChild)}
(function(c){var c=c||{},b={},e,g;e=function(c,d,a){var f=c.halt=!1;c.error=function(a){throw a;};c.next=function(a){a&&(f=!1);if(!c.halt&&d&&d.length){var a=d.shift(),e=a.shift();f=!0;try{b[e].apply(c,[a,a.length,e])}catch(g){c.error(g)}}return c};for(var g in b)typeof c[g]!=="function"&&function(a){c[a]=function(){var g=Array.prototype.slice.call(arguments);if(a==="onError"){if(d)return b.onError.apply(c,[g,g.length]),c;var l={};b.onError.apply(l,[g,g.length]);return e(l,null,"onError")}g.unshift(a);
if(!d)return e({},[g],a);c.then=c[a];d.push(g);return f?c:c.next()}}(g);a&&(c.then=c[a]);c.call=function(a,b){b.unshift(a);d.unshift(b);c.next(!0)};return c.next()};g=c.addMethod=function(g){for(var d=Array.prototype.slice.call(arguments),a=d.pop(),f=0,l=d.length;f<l;f++)typeof d[f]==="string"&&(b[d[f]]=a);--l||(b["then"+g.substr(0,1).toUpperCase()+g.substr(1)]=a);e(c)};g("chain",function(b){var d=this,a=function(){if(!d.halt){if(!b.length)return d.next(!0);try{null!=b.shift().call(d,a,d.error)&&
a()}catch(c){d.error(c)}}};a()});g("run",function(b,d){for(var a=this,c=function(){a.halt||--d||a.next(!0)},e=function(b){a.error(b)},g=0,q=d;!a.halt&&g<q;g++)null!=b[g].call(a,c,e)&&c()});g("defer",function(b){var d=this;setTimeout(function(){d.next(!0)},b.shift())});g("onError",function(b,d){var a=this;this.error=function(c){a.halt=!0;for(var e=0;e<d;e++)b[e].call(a,c)}})})(this);
addMethod("load",function(c,b){for(var e=[],g=0;g<b;g++)(function(b){e.push(function(d,a){loadScript(c[b],d,a)})})(g);this.call("run",e)});head=document.getElementsByTagName("head")[0]||document.documentElement;if(!window.console){var names=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];window.console={};for(var i=0;i<names.length;++i)window.console[names[i]]=function(){}}var Sail=window.Sail||{};
Sail.load=function(){return load("https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js","js/sail.js/deps/md5.js","js/sail.js/deps/base64.js").then("js/sail.js/deps/strophe.js","https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.js","js/sail.js/deps/jquery.url.js","js/sail.js/deps/jquery.cookie.js").then("js/sail.js/sail.rollcall.js","js/sail.js/sail.strophe.js","js/sail.js/sail.ui.js")};Sail.Event=function(c,b){this.data={};this.data.eventType=c;this.data.payload=b};
Sail.Event.prototype={toJSON:function(){return JSON.stringify(this.data)}};Sail.autobindEvents=function(c,b){var b=b||{},e;for(e in c.events)if(c.events.hasOwnProperty(e)&&typeof c.events[e]=="function"&&e.match(/^on/)){event=e.replace(/^on/,"");event=event.charAt(0).toLowerCase()+event.slice(1);try{b.pre&&$(c).bind(event,b.pre),$(c).bind(event,c.events[e]),b.post&&$(c).bind(event,b.post)}catch(g){throw alert("Sail: failed to auto-bind event! '"+event+"' may be a reserved word."),g;}}};
Sail.generateSailEventHandler=function(c){return function(b){msg=$(b);body=$(msg).children("body").text();sev=null;try{sev=JSON.parse(body)}catch(e){return}sev.from=msg.attr("from");sev.to=msg.attr("to");sev.stanza=b;c.events.sail[sev.eventType]&&$(c).trigger(c.events.sail[sev.eventType],sev);return!0}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.js");Sail=window.Sail||{};Sail.Rollcall={};Sail.Rollcall.Client=function(c){this.url=c};
Sail.Rollcall.Client.prototype={getCurrentToken:function(){return $.url.param("token")},redirectToLogin:function(){window.location.replace(this.url+"/login?destination="+escape(window.location.href))},fetchSessionForToken:function(c,b){currentUrl=$.url.attr("source");$.url.setUrl(this.url);rollcallHost=$.url.attr("host");rollcallPort=$.url.attr("port");rollcallProtocol=$.url.attr("protocol");$.url.setUrl(currentUrl);rollcallHost==$.url.attr("host")&&rollcallPort==$.url.attr("port")&&rollcallProtocol==
$.url.attr("protocol")?this.fetchSessionForTokenUsingREST(c,b):this.fetchSessionForTokenUsingJSONP(c,b)},fetchSessionForTokenUsingREST:function(c,b){var e=this;return $.ajax({url:e.url+"/sessions/validate_token.json",dataType:"json",data:{token:c},success:b,failure:function(b){console.log(b);throw"Error response from Rollcall at "+e.url;}})},fetchXMPPAuthentication:function(c){var b=this;return $.ajax({url:b.url,dataType:"json",data:{_method:"GET"},success:function(e){if(e.error)throw console.log(e),
e.error.data+" (from "+b.url+")";else c(e)}})},fetchSessionForTokenUsingJSONP:function(c,b){var e=this;return $.ajax({url:e.url+"/sessions/validate_token.json",dataType:"jsonp",data:{_method:"GET",token:c},success:function(c){if(c.error)throw console.log(c),c.error.data+" (from "+e.url+")";else b(c)}})}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.rollcall.js");Sail=window.Sail||{};Sail.WiseXMPPAuthenticate={};Sail.WiseXMPPAuthenticate.Client=function(c){this.url=c};
Sail.WiseXMPPAuthenticate.Client.prototype={getCurrentToken:function(){return $.url.param("token")},redirectToLogin:function(){window.location.replace(this.url+"/login?destination="+escape(window.location.href))},fetchSessionForToken:function(c,b){currentUrl=$.url.attr("source");$.url.setUrl(this.url);wiseXMPPAuthenticateHost=$.url.attr("host");wiseXMPPAuthenticatePort=$.url.attr("port");wiseXMPPAuthenticateProtocol=$.url.attr("protocol");$.url.setUrl(currentUrl);wiseXMPPAuthenticateHost==$.url.attr("host")&&
wiseXMPPAuthenticatePort==$.url.attr("port")&&wiseXMPPAuthenticateProtocol==$.url.attr("protocol")?this.fetchSessionForTokenUsingREST(c,b):this.fetchSessionForTokenUsingJSONP(c,b)},fetchSessionForTokenUsingREST:function(c,b){var e=this;return $.ajax({url:e.url+"/sessions/validate_token.json",dataType:"json",data:{token:c},success:b,failure:function(b){console.log(b);throw"Error response from WiseXMPPAuthenticate at "+e.url;}})},fetchSessionForTokenUsingJSONP:function(c,b){var e=this;return $.ajax({url:e.url+
"/sessions/validate_token.json",dataType:"jsonp",data:{_method:"GET",token:c},success:function(c){if(c.error)throw console.log(c),c.error.data+" (from "+e.url+")";else b(c)}})},fetchXMPPAuthentication:function(c){return $.ajax({url:this.url,dataType:"json",success:c,failure:function(){console.log("Failed to Authenticate with XMPP")}})}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.wiseauthenticate.js");Sail=window.Sail||{};
Sail.Strophe={bosh_url:null,jid:null,password:null,dataMode:"json",logLevel:Strophe.LogLevel.INFO,connect:function(){if(!this.bosh_url)throw"No bosh_url set!";if(!this.jid)throw"No jid set!";if(!this.password)throw"No password set!";this.conn=new Strophe.Connection(this.bosh_url);this.conn.reset();this.conn.xmlInput=function(){};this.conn.xmlOutput=function(){};this.conn.connect(this.jid,this.password,this.onConnect)},disconnect:function(){Sail.Strophe.conn.sync=!0;Sail.Strophe.conn.flush();Sail.Strophe.conn.disconnect()},
addHandler:function(c,b,e,g,n,d){if(!Sail.Strophe.conn)throw"Must connect before you can add handlers";Sail.Strophe.conn.addHandler(function(a){c(a);return!0},b,e,g,n,d)},pinger:function(c){c||(c=14E3);setInterval(function(){pres=$pres();Sail.Strophe.conn.send(pres.tree(),function(){},function(){});Sail.Strophe.conn.flush()},c)},onConnect:function(c){switch(c){case Strophe.Status.CONNECTED:Sail.Strophe.addDefaultHandlers();Sail.Strophe.onConnectSuccess();Sail.Strophe.pinger();break;case Strophe.Status.DISCONNECTED:Sail.Strophe.clearConnInfo()}},
onConnectSuccess:function(){return!0},onGroupchatMessage:function(){return!0},onSuccess:function(){return!0},onFailure:function(){return!0},addDefaultHandlers:function(){Sail.Strophe.conn.addHandler(Sail.Strophe.errorHandler,null,null,"error")},errorHandler:function(c){err=$(c).children("error");errMsg=err.children("text").text();alert("XMPP ERROR: "+errMsg);return!0},log:function(c,b){switch(c){case Strophe.LogLevel.DEBUG:logFunc="debug";logMsg="DEBUG: "+b;break;case Strophe.LogLevel.INFO:logFunc=
"info";logMsg="INFO: "+b;break;case Strophe.LogLevel.WARN:logFunc="warn";logMsg="WARN: "+b;break;case Strophe.LogLevel.ERROR:logFunc="error";logMsg="ERROR: "+b;break;case Strophe.LogLevel.FATAL:logFunc="error";logMsg="FATAL: "+b;break;default:logFunc="log",logMsg=b}},storeConnInfo:function(){$.cookie("Sail.jid",Sail.Strophe.conn.jid);$.cookie("Sail.sid",Sail.Strophe.conn.sid);$.cookie("Sail.rid",Sail.Strophe.conn.rid)},retrieveConnInfo:function(){return{jid:$.cookie("Sail.jid"),sid:$.cookie("Sail.sid"),
rid:$.cookie("Sail.rid")}},clearConnInfo:function(){$.cookie("Sail.jid",null);$.cookie("Sail.sid",null);$.cookie("Sail.rid",null)},hasExistingConnInfo:function(){info=Sail.Strophe.retrieveConnInfo();return info.jid&&info.rid&&info.sid},reconnect:function(){if(!this.bosh_url)throw"No bosh_url set!";info=Sail.Strophe.retrieveConnInfo();this.conn=new Strophe.Connection(this.bosh_url);this.conn.attach(info.jid,info.sid,info.rid+1)}};
Sail.Strophe.Groupchat=function(c,b){this.room=c;this.conn=b||Sail.Strophe.conn;if(!this.conn)throw"No connection given for Groupchat!";};
Sail.Strophe.Groupchat.prototype={participants:[],join:function(){pres=$pres({to:this.jid()}).c("x",{xmlns:"http://jabber.org/protocol/muc"});this.conn.send(pres.tree());this.addDefaultPresenceHandlers()},jid:function(){return this.room+"/"+Sail.Strophe.jid},sendEvent:function(c,b){Sail.Strophe.dataMode=="json"?this.sendJSON(c.toJSON(),b):this.sendText(c)},sendXML:function(c){msg=$msg({to:this.room,type:"groupchat"}).c("body").cnode($(c)[0]);this.conn.send(msg.tree())},sendText:function(c){msg=$msg({to:this.room,
type:"groupchat"}).c("body").t(c);this.conn.send(msg.tree())},sendJSON:function(c,b){json_string=typeof c=="string"?c:JSON.stringify(c);msg=b!=null?$msg({to:this.room+"/"+b,from:Sail.Strophe.jid,type:"chat"}).c("body").t(json_string):$msg({to:this.room,type:"groupchat"}).c("body").t(json_string);this.conn.send(msg.tree())},addHandler:function(c,b,e,g,n){if(!this.conn)throw"Must connect before you can add handlers";this.conn.addHandler(function(b){c(b);return!0},b,e,"groupchat",g,n)},addDefaultPresenceHandlers:function(){var c=
this;this.conn.addHandler(function(b){if($(b).attr("type")!=null)return!0;who=$(b).attr("from");c.participants.push(who);c.onParticipantJoin(who,b);return!0},null,"presence",null,null,c.room,{matchBare:!0});this.conn.addHandler(function(b){who=$(b).attr("from");c.participants.push(who);c.onParticipantLeave(who,b);return!0},null,"presence","unavailable",null,c.room,{matchBare:!0});this.conn.addHandler(function(b){if($(b).attr("type")!=null)return!0;c.onSelfJoin(b);return!0},null,"presence",null,null,
c.jid());this.conn.addHandler(function(b){c.onSelfLeave(b);return!0},null,"presence","unavailable",null,c.jid())},onParticipantJoin:function(){},onParticipantLeave:function(){},onSelfJoin:function(){},onSelfLeave:function(){},onMessage:function(){return!0}};Strophe.log=Sail.Strophe.log;typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.strophe.js");WISE={wiseXMPPAuthenticateUrl:"",xmppDomain:"localhost",groupchatRoom:"",groupchatRoomBase:"@conference.localhost",view:null,ui:Sail.UI,groupchat:null,session:null,justWatching:!1,init:function(c){view=c;WISE.wiseXMPPAuthenticateUrl=view.config.getConfigParam("wiseXMPPAuthenticateUrl")+"&workgroupId="+view.userAndClassInfo.getWorkgroupId();WISE.xmppDomain=view.config.getConfigParam("hostName");WISE.groupchatRoomBase="@conference."+WISE.xmppDomain;WISE.groupchatRoom=view.config.getConfigParam("runId")+
WISE.groupchatRoomBase;Sail.autobindEvents(WISE,{pre:function(){}});$("#pause-button").click(function(){WISE.doPause();return!1});$("#unPause-button").click(function(){WISE.doUnPause();return!1});$("#connecting").show();WISE.authenticate();return this},getJabberId:function(c){return c.split("/")[1].split("@")[0]},isEventFromTeacher:function(c){var c=c.from.split("/")[1].split("@")[0],b=view.getUserAndClassInfo().getTeacherWorkgroupId();return c==b},isEventFromStudent:function(){return!0},doPause:function(){message=
$("#pause-message").val();message==""&&$("#pause-message").val("Your teacher has paused your screen.");sev=new Sail.Event("pause",{message:message});WISE.groupchat.sendEvent(sev)},doUnPause:function(){sev=new Sail.Event("unPause");WISE.groupchat.sendEvent(sev)},authenticate:function(){WISE.wiseXMPPAuthenticate=new Sail.WiseXMPPAuthenticate.Client(WISE.wiseXMPPAuthenticateUrl);WISE.wiseXMPPAuthenticate.fetchXMPPAuthentication(function(c){WISE.xmppUsername=c.xmppUsername;WISE.xmppPassword=c.xmppPassword;
$(WISE).trigger("authenticated")})},disconnect:function(){this.doUnPause();Sail.Strophe.disconnect()},events:{sail:{pause:"pause",unPause:"unPause",studentToTeacherMsg:"studentToTeacherMsg",joinedGroupChat:"joinedGroupChat"},onAuthenticated:function(){Sail.Strophe.bosh_url="http://"+WISE.xmppDomain+"/http-bind/";var c=(new Date).getTime();Sail.Strophe.jid=WISE.xmppUsername+"@"+WISE.xmppDomain+"/"+c;Sail.Strophe.password=WISE.xmppPassword;Sail.Strophe.onConnectSuccess=function(){sailHandler=Sail.generateSailEventHandler(WISE);
Sail.Strophe.addHandler(sailHandler,null,null,"groupchat");Sail.Strophe.addHandler(sailHandler,null,null,"chat");WISE.groupchat=new Sail.Strophe.Groupchat(WISE.groupchatRoom);WISE.groupchat.onParticipantJoin=function(b){b=WISE.getJabberId(b);$("#classroomMonitorWorkgroupRow_"+b).css("background-color","white")};WISE.groupchat.onParticipantLeave=function(b){b=WISE.getJabberId(b);$("#classroomMonitorWorkgroupRow_"+b).css("background-color","lightgrey")};WISE.groupchat.onSelfJoin=function(){eventManager.fire("classroomMonitorDisplayComplete");
$("#connecting").hide()};WISE.groupchat.join()};Sail.Strophe.connect()},onPause:function(c,b){WISE.isEventFromTeacher(b)&&($("#studentScreenStatus").html("paused"),$("#studentScreenStatus").css("color","red"))},onUnPause:function(c,b){WISE.isEventFromTeacher(b)&&($("#studentScreenStatus").html("unpaused"),$("#studentScreenStatus").css("color","green"))},onStudentToTeacherMsg:function(c,b){if(WISE.isEventFromStudent(b)){var e=b.payload,g=e.workgroupId;if(e.type=="studentProgress"){var n=e.stepNumberAndTitle,
d=e.projectCompletionPercentage;$("#teamCurrentStep_"+g).html(n);$("#teamPercentProjectCompleted_"+g).html(d+"%<hr size=3 color='black' width='"+d+"%' align='left' noshade>");$("#chooseTeamToGradeTable").trigger("update");var a=e.status;a!=null&&(a.maxAlertLevel>=0&&a.maxAlertLevel<2?$("#teamStatus_"+g).html("<img src='/vlewrapper/vle/images/check16.gif' />"):a.maxAlertLevel>=2&&a.maxAlertLevel<4?$("#teamStatus_"+g).html("warning"):a.maxAlertLevel>=4&&$("#teamStatus_"+g).html("<img src='/vlewrapper/vle/images/warn16.gif' />"),
$("#teamStatus_"+g).unbind("click"),$("#teamStatus_"+g).click(function(){for(var b="",c=0;c<a.alertables.length;c++){var d=a.alertables[c];d!=null&&d.readableText!=null&&(b+=d.stepNumberAndTitle+" ("+d.nodeType+")<br>",b+=d.readableText+"<br><br>")}$("#teamStatusDialog").html(b);$("#teamStatusDialog").dialog("open")}))}}}}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/teacher.js");Sail=window.Sail||{};
Sail.UI={init:function(){$(document).ready(function(){$("button, input[type=submit]").button();$(".dialog button").click(function(){Sail.UI.dismissDialog($(this).parents(".dialog"))})})},showDialog:function(c){dialogId="sail-dialog-"+Math.floor(Math.random()*1E11).toString(16);console.debug("Sail.UI: showing dialog "+dialogId);mask=$('<div class="mask"></div>');mask.addClass(dialogId);mask.insertBefore(c);mask.css("z-index",999);$(c).css("z-index",1E3);$(c).data("sail-dialog-id",dialogId);$(c).show()},
dismissDialog:function(c){$(c).length!=0&&(dialogId=$(c).data("sail-dialog-id"),console.debug("Sail.UI: dismissing dialog "+dialogId),$(".mask."+dialogId).remove(),$(c).fadeOut("fast"))}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.ui.js");
if(typeof eventManager != 'undefined'){eventManager.fire('scriptLoaded', 'vle/minified/teacherXMPP_min.js');}
